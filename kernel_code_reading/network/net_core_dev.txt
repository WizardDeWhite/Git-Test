1. net_dev_init(), init net subsystem
================================================================================
; this function is defined like subsys_initcall(net_dev_init);
; #define subsys_initcall(fn)		__define_initcall(fn, 4)
static int __init net_dev_init(void)
1.1 dev_proc_init()
================================================================================
1.1.1 register_pernet_subsys(&dev_proc_ops)
================================================================================
1.1.1.1 proc_create_net("dev"), /proc/$$/net/dev
================================================================================
1.1.1.2 proc_create_net("softnet_stat"), /proc/$$/net/softnet_stat
================================================================================
1.1.1.3 proc_create_net("ptype"), /proc/$$/net/ptype
================================================================================
1.2 netdev_kobject_init()
================================================================================
1.2.1 kobj_ns_type_register(&net_ns_type_operations);
================================================================================
1.2.2 return class_register(&net_class);
================================================================================
1.2.2.1 net_class.dev_groups = net_class_groups, /sys/class/net/dev/xxx
================================================================================
1.3 INIT_LIST_HEAD(&ptype_base[i])
================================================================================
1.4 INIT_LIST_HEAD(&offload_base)
================================================================================
1.5 register_pernet_subsys(&netdev_net_ops), network namespace subsys
================================================================================
1.5.1 register_pernet_operations(first_device, netdev_net_ops)
================================================================================
1.5.1.1 list_add_tail(&netdev_net_ops->list, fist_device)
================================================================================
1.5.1.2 ops_init(netdev_net_ops, net), for_each_net()
================================================================================
1.6 for_each_possible_cpu(i) 
================================================================================
1.6.1 INIT_WORK(per_cpu_ptr(&flush_works,i), flush_backlog)
================================================================================
1.6.2 softnet_data *sd = &per_cpu(softnet_data, i) 
================================================================================
1.6.3 skb_queue_head_init(&sd->input_pkt_queue)
================================================================================
1.6.4 skb_queue_head_init(&sd->process_queue)
================================================================================
1.6.5 INIT_LIST_HEAD(&sd->poll_list)
================================================================================
1.6.6 sd->output_queue_tailp = &sd->output_queue
================================================================================
1.6.7 init_gro_hash(&sd->backlog)
================================================================================
1.6.8 sd->backlog.poll = process_backlog
================================================================================
1.6.9 sd->backlog.weight = weight_p
================================================================================
1.7 dev_boot_phase = 0
================================================================================
1.8 register_pernet_device(&loopback_net_ops)
================================================================================
1.9 register_pernet_device(&default_device_ops)
================================================================================
1.10 open_softirq(NET_TX_SOFTIRQ, net_tx_action)
================================================================================
1.11 open_softirq(NET_RX_SOFTIRQ, net_rx_action)
================================================================================

2. register_netdev(net_device *dev) -> register_netdevice(dev)
================================================================================
2.1 *net = dev_net(dev), get the namespace
================================================================================
2.2 ethtool_check_ops(dev->ethtool_ops)
================================================================================
2.3 netdev_set_addr_lockdep_class(dev)
================================================================================
2.4 dev_get_valid_name(net, dev, dev->name)
================================================================================
2.5 dev->netdev_ops->ndo_init(dev), device specific init
================================================================================
2.6 dev->ifindex = dev_new_index(net)
================================================================================
2.7 call_netdevice_notifiers(NETDEV_POST_INIT, dev), registered by register_netdevice_notifier()
================================================================================
2.8 netdev_register_kobject(dev)
================================================================================
2.8.1 dev = &dev->dev
================================================================================
2.8.1 device_initialize(dev)
================================================================================
2.8.2 dev->class = &net_class, /sys/class/net/xxx
================================================================================
2.8.3 device_add(dev)
================================================================================
2.8.3.1 klist_add_tail(&dev->p->knode_class, &dev->class->p->klist_devices), link to net_class
================================================================================
2.8.3.2 list_for_each_entry(class_intf, &dev->class->p->interfaces, node)
================================================================================
2.8.3.3 class_intf->add_dev(dev, class_intf)
================================================================================
2.8.4 register_queue_kobjects(dev)
================================================================================
2.8.4.1 real_rx = dev->real_num_rx_queues
================================================================================
2.8.4.2 real_tx = dev->real_num_tx_queues
================================================================================
2.8.4.3 net_rx_queue_update_kobjects(dev, 0, real_rx)
================================================================================
2.8.4.4 net_queue_update_kobjects(dev, 0, real_tx)
================================================================================
2.9 dev->reg_state = NETREG_REGISTERED
================================================================================
2.10 __netdev_update_features(dev)
================================================================================
2.11 set_bit(__LINK_STATE_PRESENT, &dev->state);
================================================================================
2.12 linkwatch_init_dev(dev);
================================================================================
2.13 dev_init_scheduler(dev)
================================================================================
2.13.1 dev->qdisc = &noop_qdisc
================================================================================
2.13.2 dev_init_scheduler_queue, for each tx queue
================================================================================
2.13.3 dev_init_scheduler_queue(dev, dev_ingress_queue(dev), &noop_qdisc)
================================================================================
2.14 dev_hold(dev)
================================================================================
2.15 list_netdevice(dev)
================================================================================
2.16 add_device_randomness(dev->dev_addr, dev->addr_len)
================================================================================
2.17 call_netdevice_notifiers(NETDEV_REGISTER, dev)
================================================================================

3. alloc_netdev(sizeof_priv, name, setup) -> alloc_netdev_mqs(, , 1, 1)
================================================================================
3.1 p = kvzalloc(alloc_size, )
================================================================================
3.2 dev_mc_init(dev)
================================================================================
3.3 dev_uc_init(dev)
================================================================================
3.4 dev_net_set(dev, &init_net)
================================================================================
3.5 setup(dev), passed from caller
================================================================================
3.6 netif_alloc_netdev_queues(dev)
================================================================================
3.6.1 dev->_tx = kvzalloc()
================================================================================
3.6.2 netdev_init_one_queue()
================================================================================
3.7 netif_alloc_rx_queues(dev)
================================================================================
3.7.1 dev->_rx = kvzalloc()
================================================================================
3.8 dev->group = INIT_NETDEV_GROUP
================================================================================
3.9 nf_hook_ingress_init(dev)
================================================================================

0. data structure
================================================================================

0.1 net_device
================================================================================

   net_device
   +---------------------------------------+
   |name[IFNAMSIZ]                         |
   |   (char)                              |
   |name_node                              |
   |   (struct netdev_name_node*)          |
   |ifalias                                |
   |   (struct dev_ifalias*)               |
   +---------------------------------------+
   |mem_end                                |
   |mem_start                              |
   |base_addr                              |
   |   (unsigned long)                     |
   |irq                                    |
   |   (int)                               |
   +---------------------------------------+
   |state                                  |
   |   (unsigned long)                     |
   |dev_list                               |
   |napi_list                              |
   |unreg_list                             |
   |close_list                             |
   |ptype_all                              |
   |ptype_specific                         |
   |   (struct list_head)                  |
   |adj_list                               |
   |   +-----------------------------------+
   |   |upper                              |
   |   |lower                              |
   |   |    (struct list_head)             |
   |   +-----------------------------------+
   |                                       |
   |features                               |
   |hw_features                            |
   |wanted_features                        |
   |vlan_features                          |
   |hw_enc_features                        |
   |mpls_features                          |
   |gso_partial_features                   |
   |   (netdev_features_t)                 |
   |                                       |
   |ifindex                                |
   |group                                  |
   |   (int)                               |
   |                                       |
   |stats                                  |
   |   (struct net_device_stats)           |
   |                                       |
   |rx_dropped                             |
   |tx_dropped                             |
   |rx_nohandler                           |
   |   (atomic_long_t)                     |
   |carrier_up_count                       |
   |carrier_down_count                     |
   |   (atomic_t)                          |
   |                                       |
   |netdev_ops                             |
   |   (struct net_device_ops*)            |
   |ethtool_ops                            |
   |   (struct ethtool_ops*)               |
   |header_ops                             |
   |   (struct header_ops*)                |
   |                                       |
   |                                       |
   |                                       |
   |mtu/min_mtu/max_mtu                    |
   |   (unsigned int)                      |
   |type                                   |
   |hard_header_len                        |
   |min_header_len                         |
   |name_assign_type                       |
   |needed_headroom/needed_tailroom        |
   |   (short/char)                        |
   |                                       |
   |perm_addr[MAX_ADDR_LEN]                |
   |addr_assign_type                       |
   |addr_len                               |
   |upper_level/lower_level                |
   |   (char)                              |
   |neigh_priv_len                         |
   |dev_id                                 |
   |dev_port                               |
   |   (short)                             |
   |                                       |
   |ip_ptr                                 |
   |   (struct in_device*)                 |
   |ip6_ptr                                |
   |   (struct inet6_dev*)                 |
   |                                       |  // receive path
   |dev_addr                               |
   |   (char *)                            |
   |_rx                                    |
   |   (struct netdev_rx_queue*)           |
   |num_rx_queues/real_num_rx_queues       |
   |   (unsigned int)                      |
   |rx_handler                             |
   |   (rx_handler_func_t)                 |
   |rx_handler_data                        |
   |   (void *)                            |
   |ingress_queue                          |
   |   (struct netdev_queue*)              |
   |broadcast[MAX_ADDR_LEN]                |
   |   (unsigned char)                     |
   |                                       |
   |                                       |  // transmit path
   |_tx                                    |
   |   (struct netdev_queue*)              |
   |num_tx_queues/real_num_tx_queues       |
   |   (unsigned int)                      |
   |qdisc                                  |  = &noop_qdisc
   |   (struct Qdisc*)                     |
   |tx_queue_len                           |
   |   (unsigned int)                      |
   |                                       |
   |phydev                                 |
   |   (struct phy_device*)                |
   |                                       |
   |                                       |
   |                                       |
   |dev                                    |
   |   (struct device)                     |
   |   +-----------------------------------+
   |   |class                              |
   |   |    (stuct class*)                 |  = net_class
   |   |                                   |
   |   |                                   |
   |   |p                                  |
   |   |    (struct device_private*)       |
   |   |    +------------------------------+
   |   |    |knode_driver                  |
   |   |    |knode_bus                     |
   |   |    |knode_class                   |
   |   |    |   (struct klist_node)        |
   |   |    |   +--------------------------+
   |   |    |   |n_node                    |
   |   |    |   |   (struct list_head)     |
   |   |    |   +--------------------------+
   |   |    |                              |
   |   |    |                              |
   +---+----+------------------------------+

0.1.1 netdev_queue
================================================================================

   netdev_queue
   +---------------------------------------+
   |dev                                    |
   |    (struct net_device*)               |
   |qdisc                                  |
   |qdisc_sleeping                         |
   |    (struct Qdisc*)                    |
   |tx_maxrate                             |
   |trans_timeout                          |
   |    (unsigned long)                    |
   |sb_dev                                 |
   |    (struct net_device*)               |
   |trans_start                            |
   |    (unsigned long)                    |
   |state                                  |
   |    (unsigned long)                    |
   |                                       |
   |_xmit_lock                             |
   |    (spinlock_t)                       |
   |                                       |
   |                                       |
   |                                       |
   +---------------------------------------+

0.1.2 Qdisc
================================================================================

   Qdisc                                        Qdisc             Qdisc
   +---------------------------------------+    +------------+    +------------+
   |next_sched                          ---|--->|            |--->|            |
   |    (struct Qdisc*)                    |    +------------+    +------------+
   |enqueue                                |
   |dequeue                                |
   |    ()                                 |
   |ops                                    |
   |    (struct Qdisc_ops*)                |
   |stab                                   |
   |    (struct qdisc_size_table*)         |
   |hash                                   |
   |    (struct hlist_node)                |
   |handle                                 |
   |parent                                 |
   |    (u32)                              |
   |dev_queue                              |
   |    (struct netdev_queue*)             |
   |q                                      |
   |    (struct qdisc_skb_head)            |
   |                                       |
   |                                       |
   |                                       |
   |                                       |
   +---------------------------------------+

0.1.3 net_device / netdev_queue / Qdisc
================================================================================

   net_device
   +---------------------------------------+<-----+
   |_tx                                    |      |
   |  (struct netdev_queue*)               |      |
   |  +------------------------------------+<--+  |
   |  |dev                             ----|------+
   |  |    (struct net_device*)            |   |
   |  |qdisc                               |   |
   |  |    (struct Qdisc*)                 |   |
   |  |    +-------------------------------+   |
   |  |    |dev_queue                  ----|---+
   |  |    |    (struct netdev_queue)      |
   |  |    |                               |
   +--+----+-------------------------------+

0.2 net
================================================================================

   net
   +---------------------------------------+
   |list                                   |
   |   (struct list_head)                  |
   |passive                                |
   |count                                  |
   |   (refcount_t)                        |
   |list                                   |
   |   (struct list_head)                  |
   |                                       |
   +---------------------------------------+

0.3 ptype_all / ptype_base
================================================================================

   ptype_all
   +------------------+
   |list_head         |
   +------------------+


   ptype_base[PTYPE_HASH_SIZE]
   +------------------+
   |list_head         |
   +------------------+
   |list_head         |
   +------------------+
           .
           .
           .
   +------------------+
   |list_head         |
   +------------------+
   |list_head         |
   +------------------+

0.4 net_class
================================================================================

   net_class
   +---------------------------------------+
   |name                                   |
   |    (char *)                           |
   |dev_kobj                               |
   |    (struct kobject*)                  |
   |class_groups                           |
   |dev_groups                             |  = net_class_groups
   |    (struct attribute_group**)         |
   |namespace                              |  = net_namespace
   |    (void *(*)())                      |
   |                                       |
   |p                                      |
   |    (struct subsys_private*)           |
   |    +----------------------------------+
   |    |subsys                            |
   |    |    (struct kset)                 |
   |    |device_kset                       |
   |    |    (struct kset*)                |
   |    |interfaces                        |
   |    |    (struct list_head)            |
   |    |                                  |
   |    |                                  |
   |    |klist_drivers                     |
   |    |    (struct klist)                |
   |    |    +-----------------------------+
   |    |    |                             |
   |    |    +-----------------------------+
   |    |klist_devices                     |    net_device
   |    |    (struct klist)                |    +------------------+
   |    |    +-----------------------------+    |                  |
   |    |    |k_list                       |    +------------------+
   |    |    |    (struct list_head)       |
   |    |    |get                          |  = klist_class_dev_get
   |    |    |put                          |  = klist_class_dev_put
   |    |    |                             |
   |    |    +-----------------------------+
   |    |bus                               |
   |    |    (struct bus_type*)            |
   |    |class                             |
   |    |    (struct class*)               |
   |    |                                  |
   +----+----------------------------------+
